<!doctype html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#D97706" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <meta name="apple-mobile-web-app-title" content="CERCLE PRIV√â" />
    <meta name="description" content="L'excellence immobili√®re en toute discr√©tion - Biens de prestige en off-market" />
    <meta name="language" content="fr" />
    
    <!-- Apple Touch Icons -->
    <link rel="apple-touch-icon" href="/icon-192.png" />
    <link rel="apple-touch-icon" sizes="192x192" href="/icon-192.png" />
    <link rel="apple-touch-icon" sizes="512x512" href="/icon-512.png" />
    
    <!-- Manifest -->
    <link rel="manifest" href="/manifest.json" />
    
    <!-- HTTPS Security Headers -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' https: data: blob:; script-src 'self' 'unsafe-inline' 'unsafe-eval' https: data:; style-src 'self' 'unsafe-inline' https: data:; img-src 'self' data: https: blob:; font-src 'self' https: data:; connect-src 'self' https: wss:; manifest-src 'self';">
    
    <title>CERCLE PRIV√â - Immobilier de Prestige</title>
    
    <style>
      /* CSS critique pour √©viter la page blanche - Version ultra-robuste */
      body {
        margin: 0;
        padding: 0;
        font-family: system-ui, -apple-system, sans-serif;
        background: #111827;
        color: white;
        overflow-x: hidden;
        visibility: hidden;
        top: 0;
        left: 0;
      /* Assurer que le root est visible */
      #root { min-height: 100vh; background: #111827; }
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        transition: opacity 0.5s ease-out;
        visibility: visible !important;
      }
      
      .emergency-title {
        color: #D97706;
        font-size: 2rem;
        font-weight: 300;
        letter-spacing: 0.2em;
        margin-bottom: 2rem;
        text-align: center;
        animation: fadeInUp 1s ease-out;
      }
      
      .emergency-spinner {
        width: 3rem;
        height: 3rem;
        border: 3px solid #374151;
        border-top: 3px solid #D97706;
        border-radius: 50%;
        animation: spin 1.5s linear infinite;
        margin-bottom: 1rem;
      }
      
      .emergency-message {
        color: #9CA3AF;
        font-size: 0.9rem;
        text-align: center;
        max-width: 400px;
        line-height: 1.5;
        margin-bottom: 2rem;
      }
      
      .emergency-actions {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
        justify-content: center;
      }
      
      .emergency-btn {
        background: #D97706;
        color: white;
        border: none;
        padding: 0.75rem 1.5rem;
        border-radius: 0.375rem;
        cursor: pointer;
        font-size: 0.9rem;
        font-weight: 500;
        transition: background 0.3s ease;
      }
      
      .emergency-btn:hover {
        background: #B45309;
      }
      
      .emergency-btn.secondary {
        background: transparent;
        border: 1px solid #D97706;
        color: #D97706;
      }
      
      .emergency-btn.secondary:hover {
        background: #D97706;
        color: white;
      }
      
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
      
      /* Masquer le loader seulement quand l'app est vraiment pr√™te */
        0% { opacity: 0; transform: translateY(20px); }
        100% { opacity: 1; transform: translateY(0); }
      }
      
      /* Masquer le loader quand l'app est pr√™te */
      .app-loaded #emergency-loader {
        opacity: 0;
        pointer-events: none;
      }
      
      /* Styles de base pour √©viter FOUC */
      #root {
        min-height: 100vh;
        background: #111827;
      }
      
      /* Optimisations de performance */
      * {
        box-sizing: border-box;
      }
      
      img {
        max-width: 100%;
        height: auto;
        image-rendering: auto;
      }
      
      /* PWA Install button styles */
      .pwa-install-available {
        position: relative;
      }
      
      .pwa-install-available::after {
        content: "üì±";
        position: absolute;
        top: -5px;
        right: -5px;
        font-size: 12px;
        animation: bounce 2s infinite;
      }
    </style>
  </head>
  <body>
    <!-- Loader de secours ultra-robuste -->
    <div id="emergency-loader">
      <h1 class="emergency-title">CERCLE PRIV√â</h1>
      <div class="emergency-spinner"></div>
      <p class="emergency-message">
        Chargement de votre espace immobilier de prestige...<br>
        Application web progressive en cours de chargement...
      </p>
      <div class="emergency-actions">
        <button class="emergency-btn" onclick="window.location.reload()">
          Actualiser la page
        </button>
        <button class="emergency-btn secondary" onclick="localStorage.clear(); window.location.reload();">
          Vider le cache
        </button>
        <button class="emergency-btn secondary" onclick="installPWAManually()">
          Installer l'app
        </button>
        <button class="emergency-btn secondary" onclick="window.location.href='mailto:nicolas.c@lacremerie.fr?subject=Probl√®me technique site'">
          Signaler le probl√®me
        </button>
      </div>
    </div>
    
    <div id="root"></div>
    <script type="module" src="/src/main.tsx"></script>
    
    <script>
      // Installation PWA manuelle
      function installPWAManually() {
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
        const isAndroid = /Android/.test(navigator.userAgent);
        
        if (isIOS) {
          alert('üì± Installation sur iOS :\n\n1. Appuyez sur le bouton Partager (carr√© avec fl√®che)\n2. Faites d√©filer et s√©lectionnez "Sur l\'√©cran d\'accueil"\n3. Appuyez sur "Ajouter" pour confirmer\n\n‚ú® L\'app appara√Ætra sur votre √©cran d\'accueil !');
        } else if (isAndroid) {
          alert('üì± Installation sur Android :\n\n1. Appuyez sur le menu (‚ãÆ) en haut √† droite\n2. S√©lectionnez "Ajouter √† l\'√©cran d\'accueil"\n3. Confirmez en appuyant sur "Ajouter"\n\n‚ú® L\'app sera disponible sur votre √©cran d\'accueil !');
        } else {
          alert('üíª Installation sur Desktop :\n\n1. Cherchez l\'ic√¥ne d\'installation (‚äï) dans la barre d\'adresse\n2. Ou cliquez sur Menu ‚Üí "Installer CERCLE PRIV√â"\n3. Confirmez l\'installation\n\n‚ú® L\'app s\'ouvrira dans sa propre fen√™tre !');
        }
      }
      
      // Diagnostic et r√©cup√©ration automatique ultra-robuste
      (function() {
        console.log('üîß PWA: Diagnostic automatique d√©marr√©');
        
        let loadingTimeout;
        let emergencyTimeout;
        let retryCount = 0;
        const maxRetries = 3;
        
        // Enregistrer le Service Worker
        if ('serviceWorker' in navigator) {
          window.addEventListener('load', function() {
            navigator.serviceWorker.register('/sw.js')
              .then(function(registration) {
                console.log('SW: Enregistrement r√©ussi', registration.scope);
              })
              .catch(function(error) {
                console.log('SW: √âchec enregistrement', error);
              });
          });
        }
        
        // Fonction de diagnostic
        function diagnoseAndRecover() {
          console.log('üîç PWA: Diagnostic en cours...');
          
          // V√©rifier si React est charg√©
          const checkReactLoaded = () => {
            return window.React || document.querySelector('[data-reactroot]') || document.querySelector('#root').children.length > 0;
          };
          
          // V√©rifier les erreurs JavaScript
          const hasJSErrors = window.jsErrorCount > 0;
          
          // V√©rifier la connectivit√© r√©seau
          const isOnline = navigator.onLine;
          
          console.log('üìä PWA: √âtat du diagnostic:', {
            reactLoaded: checkReactLoaded(),
            hasJSErrors,
            isOnline,
            retryCount
          });
          
          return {
            reactLoaded: checkReactLoaded(),
            hasJSErrors,
            isOnline
          };
        }
        
        // Fonction de r√©cup√©ration
        function attemptRecovery() {
          const diagnosis = diagnoseAndRecover();
          
          if (!diagnosis.isOnline) {
            console.warn('üåê PWA: Probl√®me de connectivit√© d√©tect√©');
            updateEmergencyMessage('Probl√®me de connexion internet d√©tect√©. V√©rifiez votre connexion.');
            return;
          }
          
          if (!diagnosis.reactLoaded && retryCount < maxRetries) {
            retryCount++;
            console.log(`üîÑ PWA: Tentative de r√©cup√©ration ${retryCount}/${maxRetries}`);
            
            // Nettoyer et recharger
            if (retryCount === 2) {
              console.log('üßπ PWA: Nettoyage du cache...');
              try {
                localStorage.clear();
                sessionStorage.clear();
              } catch (e) {
                console.warn('Erreur nettoyage cache:', e);
              }
            }
            
            setTimeout(() => {
              window.location.reload();
            }, 2000);
            
            updateEmergencyMessage(`R√©cup√©ration en cours... (${retryCount}/${maxRetries})`);
            return;
          }
          
          if (retryCount >= maxRetries) {
            console.error('üö® PWA: √âchec de r√©cup√©ration automatique');
            showEmergencyOptions();
            return;
          }
        }
        
        // Mettre √† jour le message d'urgence
        function updateEmergencyMessage(message) {
          const messageEl = document.querySelector('.emergency-message');
          if (messageEl) {
            messageEl.textContent = message;
          }
        }
        
        // Afficher les options d'urgence
        function showEmergencyOptions() {
          updateEmergencyMessage('Probl√®me technique d√©tect√©. Utilisez les options ci-dessous pour r√©soudre le probl√®me.');
          
          const actionsEl = document.querySelector('.emergency-actions');
          if (actionsEl) {
            actionsEl.style.display = 'flex';
          }
        }
        
        // Masquer le loader quand l'app est pr√™te
        function hideLoader() {
          console.log('‚úÖ PWA: Application charg√©e avec succ√®s');
          document.body.classList.add('app-loaded');
          
          setTimeout(() => {
            const loader = document.getElementById('emergency-loader');
            if (loader) {
              loader.style.display = 'none';
            }
          }, 500);
        }
        
        // Compteur d'erreurs JavaScript
        window.jsErrorCount = 0;
        window.addEventListener('error', function(e) {
          window.jsErrorCount++;
          console.error('‚ùå PWA: Erreur JS:', e.error?.message || e.message);
        });
        
        window.addEventListener('unhandledrejection', function(e) {
          window.jsErrorCount++;
          console.error('‚ùå PWA: Promise rejet√©e:', e.reason);
        });
        
        // Timeout principal de s√©curit√©
        loadingTimeout = setTimeout(() => {
          console.warn('‚è∞ PWA: Timeout de chargement atteint');
          attemptRecovery();
        }, 5000);
        
        // Timeout d'urgence absolu
        emergencyTimeout = setTimeout(() => {
          console.error('üö® PWA: Timeout d\'urgence - Affichage des options');
          showEmergencyOptions();
        }, 15000);
        
        // D√©tecter le chargement r√©ussi
        window.addEventListener('load', function() {
          clearTimeout(loadingTimeout);
          clearTimeout(emergencyTimeout);
          
          // V√©rifier si React est mont√©
          setTimeout(() => {
            const diagnosis = diagnoseAndRecover();
            if (diagnosis.reactLoaded) {
              hideLoader();
            } else {
              console.warn('‚ö†Ô∏è PWA: React non d√©tect√© apr√®s load');
              attemptRecovery();
            }
          }, 1000);
        });
        
        // D√©tecter le montage de React
        const observer = new MutationObserver(function(mutations) {
          mutations.forEach(function(mutation) {
            if (mutation.addedNodes.length > 0) {
              const rootEl = document.getElementById('root');
              if (rootEl && rootEl.children.length > 0) {
                clearTimeout(loadingTimeout);
                clearTimeout(emergencyTimeout);
                hideLoader();
                observer.disconnect();
              }
            }
          });
        });
        
        observer.observe(document.getElementById('root'), {
          childList: true,
          subtree: true
        });
        
        // Diagnostic initial
        console.log('üöÄ PWA: Syst√®me de diagnostic initialis√©');
        
      })();
    </script>
  </body>
</html>